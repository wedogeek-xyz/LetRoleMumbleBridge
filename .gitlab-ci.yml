stages:
  - build
  - release

# ──────────────────────────────────────────────────────────────────
# Build du .exe Windows
# PRÉREQUIS : runner Windows auto-hébergé taggé "windows"
#   1. Installe GitLab Runner sur ta machine Windows
#   2. gitlab-runner register --url https://gitlab.com --tag-list windows
#   3. Python + pip doivent être dans le PATH du runner
# ──────────────────────────────────────────────────────────────────
build-exe:
  stage: build
  tags:
    - windows
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - cd mumble_bridge
    - pip install pyinstaller websockets --quiet
    - python build.py
    - python -c "import shutil; shutil.copy('scenes_config.json', 'dist/')"
  artifacts:
    name: "mumble-bridge-$CI_COMMIT_TAG"
    paths:
      - mumble_bridge/dist/mumble_bridge_v2.exe
      - mumble_bridge/dist/scenes_config.json
    expire_in: 30 days

# ──────────────────────────────────────────────────────────────────
# Zip de l'extension Chrome
# ──────────────────────────────────────────────────────────────────
build-extension:
  stage: build
  image: alpine:latest
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - apk add --no-cache zip
    - zip -r lets-role-spatial-audio.zip extension/ --exclude "extension/*.zip"
  artifacts:
    name: "extension-$CI_COMMIT_TAG"
    paths:
      - lets-role-spatial-audio.zip
    expire_in: 30 days

# ──────────────────────────────────────────────────────────────────
# Création de la release GitLab avec les fichiers en assets
# ──────────────────────────────────────────────────────────────────
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build-exe
      artifacts: true
    - job: build-extension
      artifacts: true
  rules:
    - if: $CI_COMMIT_TAG
  before_script:
    - apk add --no-cache curl
    - >
      curl --fail --header "JOB-TOKEN: $CI_JOB_TOKEN"
      --upload-file mumble_bridge/dist/mumble_bridge_v2.exe
      "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/mumble-bridge/${CI_COMMIT_TAG}/mumble_bridge_v2.exe"
    - >
      curl --fail --header "JOB-TOKEN: $CI_JOB_TOKEN"
      --upload-file mumble_bridge/dist/scenes_config.json
      "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/mumble-bridge/${CI_COMMIT_TAG}/scenes_config.json"
    - >
      curl --fail --header "JOB-TOKEN: $CI_JOB_TOKEN"
      --upload-file lets-role-spatial-audio.zip
      "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/extension/${CI_COMMIT_TAG}/lets-role-spatial-audio.zip"
  script:
    - echo "Release $CI_COMMIT_TAG publiée"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release $CI_COMMIT_TAG"
    description: |
      ## Let's Role · Spatial Audio

      ### Téléchargements

      | Fichier | Description |
      |---|---|
      | `mumble_bridge_v2.exe` | Pont Mumble — Windows |
      | `scenes_config.json` | Config des scènes (à placer à côté de l'exe) |
      | `lets-role-spatial-audio.zip` | Extension Chrome |
    assets:
      links:
        - name: "mumble_bridge_v2.exe"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/mumble-bridge/${CI_COMMIT_TAG}/mumble_bridge_v2.exe"
          link_type: package
        - name: "scenes_config.json"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/mumble-bridge/${CI_COMMIT_TAG}/scenes_config.json"
          link_type: other
        - name: "lets-role-spatial-audio.zip"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/extension/${CI_COMMIT_TAG}/lets-role-spatial-audio.zip"
          link_type: package
